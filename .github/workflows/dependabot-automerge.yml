name: Dependabot auto-merge

"on":
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: Auto-merge (Dependabot only)
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fetch metadata
        id: dependabot
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge (minor/patch only, after required checks)
        if: ${{ steps.dependabot.outputs.update-type == 'version-update:semver-minor' || steps.dependabot.outputs.update-type == 'version-update:semver-patch' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Prefer repo auto-merge (merge queue / branch policy compliant) now that it is enabled.
          # If auto-merge is disabled, we fall back to polling + direct merge.
          set +e
          out="$(gh pr merge --auto --squash --delete-branch \"$PR_URL\" --repo \"$REPO\" 2>&1)"
          rc=$?
          set -e
          if [[ \"$rc\" -eq 0 ]]; then
            exit 0
          fi
          if ! echo \"$out\" | grep -q \"enablePullRequestAutoMerge\"; then
            echo \"Auto-merge failed: $out\"
            exit 1
          fi
          echo \"Repo auto-merge disabled; falling back to wait+direct merge.\"

          max_attempts=90      # ~30 minutes at 20s intervals
          sleep_seconds=20

          for i in $(seq 1 "$max_attempts"); do
            PR_JSON="$(gh pr view "$PR_URL" --repo "$REPO" --json mergeStateStatus,isDraft,statusCheckRollup)"
            MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"
            IS_DRAFT="$(echo "$PR_JSON" | jq -r '.isDraft')"

            if [[ "$IS_DRAFT" == "true" ]]; then
              echo "Skip: PR is draft"
              exit 0
            fi

            # If behind, update the PR branch from main and keep waiting.
            if [[ "$MERGE_STATE" == "BEHIND" ]]; then
              echo "PR is BEHIND; updating branch from main..."
              PR_ID="$(gh pr view "$PR_URL" --repo "$REPO" --json id --jq '.id')"
              HEAD_OID="$(gh pr view "$PR_URL" --repo "$REPO" --json headRefOid --jq '.headRefOid')"
              gh api graphql -f query='
                mutation($prId:ID!, $expected:GitObjectID!) {
                  updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                    pullRequest { number }
                  }
                }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null
              echo "Updated branch; waiting for CI..."
              sleep "$sleep_seconds"
              continue
            fi

            # Determine if all checks are completed and successful (or skipped/neutral).
            TOTAL="$(echo "$PR_JSON" | jq '.statusCheckRollup | length')"
            if [[ "$TOTAL" -eq 0 ]]; then
              echo "No checks yet (attempt $i/$max_attempts)."
              sleep "$sleep_seconds"
              continue
            fi

            NOT_DONE="$(echo "$PR_JSON" | jq '[.statusCheckRollup[] | select(.status != "COMPLETED")] | length')"
            FAILURES="$(echo "$PR_JSON" | jq '[.statusCheckRollup[] | select((.conclusion // "") | test("FAILURE|CANCELLED|TIMED_OUT|ACTION_REQUIRED|STARTUP_FAILURE"))] | length')"

            if [[ "$NOT_DONE" -gt 0 ]]; then
              echo "Checks still running ($NOT_DONE pending) (attempt $i/$max_attempts)."
              sleep "$sleep_seconds"
              continue
            fi

            if [[ "$FAILURES" -gt 0 ]]; then
              echo "Checks failed; not merging."
              exit 0
            fi

            if [[ "$MERGE_STATE" != "CLEAN" ]]; then
              echo "Not mergeable yet (mergeStateStatus=$MERGE_STATE) (attempt $i/$max_attempts)."
              sleep "$sleep_seconds"
              continue
            fi

            echo "Merging Dependabot PR now."
            gh pr merge "$PR_URL" --repo "$REPO" --squash --delete-branch
            exit 0
          done

          echo "Timed out waiting for checks/mergeability; leaving PR open."
          exit 0


