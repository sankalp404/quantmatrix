name: QuantMatrix Tests

"on":
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    
    - name: Prepare test env
      run: |
        cp infra/env.test.example infra/env.test

    - name: Run backend tests (isolated postgres_test)
      run: |
        make test-up
        make test

    - name: Tear down test stack
      if: always()
      run: |
        make test-down

  frontend-tests:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    - name: Set up Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version-file: .node-version
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Lint
      run: npm run lint

    - name: Typecheck
      run: npm run type-check

    - name: Unit tests
      run: npm run test

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    - name: Run Python security scan
      run: |
        pip install safety bandit
        safety check -r requirements.txt || echo "Security issues found"
        bandit -r backend/ -f json || echo "Security scan completed with warnings"
      continue-on-error: true

  notify-status:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    steps:
    - name: Report Results
      run: |
        echo "üß™ Test Results Summary:"
        echo "Backend Tests: ${{ needs.backend-tests.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        
        if [[ "${{ needs.backend-tests.result }}" == "success" && "${{ needs.frontend-tests.result }}" == "success" ]]; then
          echo "‚úÖ All tests passed!"
        else
          echo "‚ùå Some tests failed - check logs above"
        fi 