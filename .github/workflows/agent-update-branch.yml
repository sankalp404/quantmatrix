name: Update agent PR branch from main (when ready)

on:
  pull_request:
    types: [ready_for_review, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  update_if_behind:
    name: Update branch if behind main
    runs-on: ubuntu-latest
    steps:
      - name: Update branch from main (agent/** only)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          # Only handle agent branches
          if [[ "$HEAD_REF" != agent/* ]]; then
            echo "Skip: not an agent branch ($HEAD_REF)"
            exit 0
          fi

          # Only update when the PR is ready for review (avoid churning draft PRs).
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "Skip: PR is draft"
            exit 0
          fi

          PR_JSON="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json id,headRefOid,mergeStateStatus)"
          PR_ID="$(echo "$PR_JSON" | jq -r '.id')"
          HEAD_OID="$(echo "$PR_JSON" | jq -r '.headRefOid')"
          MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"

          if [[ "$MERGE_STATE" != "BEHIND" ]]; then
            echo "No update needed (mergeStateStatus=$MERGE_STATE)"
            exit 0
          fi

          echo "Updating PR #$PR_NUMBER branch from main..."
          gh api graphql -f query='
            mutation($prId:ID!, $expected:GitObjectID!) {
              updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                pullRequest { number }
              }
            }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null


