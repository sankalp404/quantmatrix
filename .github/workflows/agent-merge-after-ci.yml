name: Auto-squash merge agent PRs after CI (when approved)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  merge_if_approved:
    name: Merge (squash) if approved
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Merge approved agent PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "workflow_run" ]]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            CI_SHA="${{ github.event.workflow_run.head_sha }}"
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            BRANCH="${{ github.event.pull_request.head.ref }}"
            CI_SHA=""  # not available/relevant for review-triggered runs
          else
            echo "Unsupported event: $EVENT"
            exit 0
          fi

          # Only handle agent branches
          if [[ "$BRANCH" != agent/* ]]; then
            echo "Skip: not an agent branch ($BRANCH)"
            exit 0
          fi

          # Find the open PR for this head branch (if any)
          if [[ "$EVENT" == "pull_request_review" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            PR_NUMBER="$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number --jq '.[0].number')"
          fi
          if [[ -z "${PR_NUMBER:-}" || "${PR_NUMBER}" == "null" ]]; then
            echo "No open PR found for $BRANCH"
            exit 0
          fi

          PR_JSON="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json id,headRefOid,mergeStateStatus,reviews,isDraft)"
          PR_ID="$(echo "$PR_JSON" | jq -r '.id')"
          HEAD_OID="$(echo "$PR_JSON" | jq -r '.headRefOid')"
          MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"
          IS_DRAFT="$(echo "$PR_JSON" | jq -r '.isDraft')"

          # For workflow_run, ensure the run corresponds to the current PR head SHA.
          if [[ "$EVENT" == "workflow_run" ]]; then
            if [[ "$HEAD_OID" != "$CI_SHA" ]]; then
              echo "Skip: CI SHA ($CI_SHA) != PR head ($HEAD_OID). New commits likely pushed."
              exit 0
            fi
          fi

          # Never auto-merge draft PRs (must be marked Ready for review first).
          if [[ "$IS_DRAFT" == "true" ]]; then
            echo "Skip: PR #$PR_NUMBER is draft"
            exit 0
          fi

          APPROVED_BY_OWNER="$(echo "$PR_JSON" | jq -r '[.reviews[] | select(.state=="APPROVED") | .author.login] | any(. == "sankalp404")')"
          if [[ "$APPROVED_BY_OWNER" != "true" ]]; then
            echo "PR #$PR_NUMBER not approved by sankalp404"
            exit 0
          fi

          # If branch is behind main (ruleset requires up-to-date), update it from main and rerun CI.
          if [[ "$MERGE_STATE" == "BEHIND" ]]; then
            echo "PR #$PR_NUMBER is BEHIND main; updating branch then rerunning CI."

            gh api graphql -f query='
              mutation($prId:ID!, $expected:GitObjectID!) {
                updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                  pullRequest { number }
                }
              }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null

            # CI may not fire automatically for bot-created PR events; dispatch explicitly.
            gh workflow run "CI" --repo "$REPO" --ref "$BRANCH"
            exit 0
          fi

          # GitHub can report mergeStateStatus=UNSTABLE for a short window even when checks are about to go green.
          # Poll for a bounded amount of time to avoid missing the merge window.
          max_attempts=60     # ~10 minutes at 10s
          sleep_seconds=10

          for i in $(seq 1 "$max_attempts"); do
            PR_JSON="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergeStateStatus,isDraft,reviews)"
            MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"
            IS_DRAFT="$(echo "$PR_JSON" | jq -r '.isDraft')"

            if [[ "$IS_DRAFT" == "true" ]]; then
              echo "Skip: PR #$PR_NUMBER is draft"
              exit 0
            fi

            APPROVED_BY_OWNER="$(echo "$PR_JSON" | jq -r '[.reviews[] | select(.state=="APPROVED") | .author.login] | any(. == "sankalp404")')"
            if [[ "$APPROVED_BY_OWNER" != "true" ]]; then
              echo "Skip: PR #$PR_NUMBER not approved by sankalp404"
              exit 0
            fi

            if [[ "$MERGE_STATE" == "CLEAN" ]]; then
              echo "Merging PR #$PR_NUMBER (mergeStateStatus=CLEAN)"
              gh pr merge "$PR_NUMBER" --repo "$REPO" --squash --delete-branch
              exit 0
            fi

            if [[ "$MERGE_STATE" == "BEHIND" ]]; then
              echo "PR #$PR_NUMBER is BEHIND main; updating branch then rerunning CI."
              PR_ID="$(echo "$PR_JSON" | jq -r '.id' 2>/dev/null || true)"
              HEAD_OID="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRefOid --jq '.headRefOid')"
              # PR_ID may not be present in the reduced json above; fetch it if needed.
              if [[ -z "${PR_ID:-}" || "${PR_ID}" == "null" ]]; then
                PR_ID="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json id --jq '.id')"
              fi
              gh api graphql -f query='
                mutation($prId:ID!, $expected:GitObjectID!) {
                  updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                    pullRequest { number }
                  }
                }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null
              gh workflow run "CI" --repo "$REPO" --ref "$BRANCH"
              exit 0
            fi

            echo "Waiting for mergeability... (mergeStateStatus=$MERGE_STATE) attempt $i/$max_attempts"
            sleep "$sleep_seconds"
          done

          echo "Timed out waiting for mergeStateStatus=CLEAN; leaving PR open."
          exit 0


