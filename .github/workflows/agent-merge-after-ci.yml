name: Auto-squash merge agent PRs after CI (when approved)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  merge_if_approved:
    name: Merge (squash) if approved
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Merge approved agent PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "workflow_run" ]]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            CI_SHA="${{ github.event.workflow_run.head_sha }}"
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            BRANCH="${{ github.event.pull_request.head.ref }}"
            CI_SHA=""  # not available/relevant for review-triggered runs
          else
            echo "Unsupported event: $EVENT"
            exit 0
          fi

          # Only handle agent branches
          if [[ "$BRANCH" != agent/* ]]; then
            echo "Skip: not an agent branch ($BRANCH)"
            exit 0
          fi

          # Find the open PR for this head branch (if any)
          if [[ "$EVENT" == "pull_request_review" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            PR_NUMBER="$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number --jq '.[0].number')"
          fi
          if [[ -z "${PR_NUMBER:-}" || "${PR_NUMBER}" == "null" ]]; then
            echo "No open PR found for $BRANCH"
            exit 0
          fi

          PR_JSON="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json id,headRefOid,mergeStateStatus,reviews,isDraft)"
          PR_ID="$(echo "$PR_JSON" | jq -r '.id')"
          HEAD_OID="$(echo "$PR_JSON" | jq -r '.headRefOid')"
          MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"
          IS_DRAFT="$(echo "$PR_JSON" | jq -r '.isDraft')"

          # For workflow_run, ensure the run corresponds to the current PR head SHA.
          if [[ "$EVENT" == "workflow_run" ]]; then
            if [[ "$HEAD_OID" != "$CI_SHA" ]]; then
              echo "Skip: CI SHA ($CI_SHA) != PR head ($HEAD_OID). New commits likely pushed."
              exit 0
            fi
          fi

          # Never auto-merge draft PRs (must be marked Ready for review first).
          if [[ "$IS_DRAFT" == "true" ]]; then
            echo "Skip: PR #$PR_NUMBER is draft"
            exit 0
          fi

          APPROVED_BY_OWNER="$(echo "$PR_JSON" | jq -r '[.reviews[] | select(.state=="APPROVED") | .author.login] | any(. == "sankalp404")')"
          if [[ "$APPROVED_BY_OWNER" != "true" ]]; then
            echo "PR #$PR_NUMBER not approved by sankalp404"
            exit 0
          fi

          # If branch is behind main (ruleset requires up-to-date), update it from main and rerun CI.
          if [[ "$MERGE_STATE" == "BEHIND" ]]; then
            echo "PR #$PR_NUMBER is BEHIND main; updating branch then rerunning CI."

            gh api graphql -f query='
              mutation($prId:ID!, $expected:GitObjectID!) {
                updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                  pullRequest { number }
                }
              }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null

            # CI may not fire automatically for bot-created PR events; dispatch explicitly.
            gh workflow run "CI" --repo "$REPO" --ref "$BRANCH"
            exit 0
          fi

          # Do not rely on GitHub "auto-merge" (enablePullRequestAutoMerge). This repo may have it disabled.
          # Only merge when GitHub reports the PR is mergeable now.
          if [[ "$MERGE_STATE" != "CLEAN" ]]; then
            echo "Skip: PR #$PR_NUMBER not mergeable yet (mergeStateStatus=$MERGE_STATE)"
            exit 0
          fi

          # Merge now (CI is green or already passed, and PR is mergeable).
          gh pr merge "$PR_NUMBER" --repo "$REPO" --squash --delete-branch


