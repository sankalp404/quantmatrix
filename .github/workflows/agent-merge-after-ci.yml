name: Auto-squash merge agent PRs after CI (when approved)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  merge_if_approved:
    name: Merge (squash) if approved
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Merge approved agent PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          CI_SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Only handle agent branches
          if [[ "$BRANCH" != agent/* ]]; then
            echo "Skip: not an agent branch ($BRANCH)"
            exit 0
          fi

          # Find the open PR for this head branch (if any)
          PR_NUMBER="$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number --jq '.[0].number')"
          if [[ -z "${PR_NUMBER:-}" || "${PR_NUMBER}" == "null" ]]; then
            echo "No open PR found for $BRANCH"
            exit 0
          fi

          PR_JSON="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json id,headRefOid,mergeStateStatus,reviewDecision,reviews)"
          PR_ID="$(echo "$PR_JSON" | jq -r '.id')"
          HEAD_OID="$(echo "$PR_JSON" | jq -r '.headRefOid')"
          MERGE_STATE="$(echo "$PR_JSON" | jq -r '.mergeStateStatus')"
          DECISION="$(echo "$PR_JSON" | jq -r '.reviewDecision')"

          # Ensure this workflow_run corresponds to the current PR head SHA.
          if [[ "$HEAD_OID" != "$CI_SHA" ]]; then
            echo "Skip: CI SHA ($CI_SHA) != PR head ($HEAD_OID). New commits likely pushed."
            exit 0
          fi

          # Require that the PR is approved by sankalp404 (branch rules enforce this too,
          # but we keep it as a hard gate here).
          if [[ "$DECISION" != "APPROVED" ]]; then
            echo "PR #$PR_NUMBER is not approved (reviewDecision=$DECISION)"
            exit 0
          fi

          APPROVED_BY_OWNER="$(echo "$PR_JSON" | jq -r '[.reviews[] | select(.state=="APPROVED") | .author.login] | any(. == "sankalp404")')"
          if [[ "$APPROVED_BY_OWNER" != "true" ]]; then
            echo "PR #$PR_NUMBER not approved by sankalp404"
            exit 0
          fi

          # If branch is behind main (ruleset requires up-to-date), update it from main and rerun CI.
          if [[ "$MERGE_STATE" == "BEHIND" ]]; then
            echo "PR #$PR_NUMBER is BEHIND main; updating branch then rerunning CI."

            gh api graphql -f query='
              mutation($prId:ID!, $expected:GitObjectID!) {
                updatePullRequestBranch(input:{pullRequestId:$prId, expectedHeadOid:$expected}) {
                  pullRequest { number }
                }
              }' -f prId="$PR_ID" -f expected="$HEAD_OID" >/dev/null

            # CI may not fire automatically for bot-created PR events; dispatch explicitly.
            gh workflow run "CI" --repo "$REPO" --ref "$BRANCH"
            exit 0
          fi

          # Merge now (CI just passed). This will still be blocked if ruleset isn't satisfied.
          gh pr merge "$PR_NUMBER" --repo "$REPO" --squash --delete-branch


